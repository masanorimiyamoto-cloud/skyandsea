<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿å…¥åŠ› - BookSKY_NET (ãƒ­ã‚°ã‚¤ãƒ³ç‰ˆ0612)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            padding: 20px;
            margin: 0; /* bodyã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
        }
        .container {
            max-width: 400px;
            margin: auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: left;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 20px; 
            box-sizing: border-box;
        }
        input[readonly] { /* èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        button {
            background-color: #007bff;
            color: white;
            font-size: 18px;
            border: none;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #submitButton {
            margin-top: 30px;
        }
        .message {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .header { text-align: center; margin-bottom: 20px; }
        .logo { max-width: 100px; height: auto; margin-bottom: 10px; }
        .user-info { 
            margin-bottom: 15px; 
            padding: 10px; 
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px; 
            text-align: center; 
            font-size: 0.9em;
        }
        .user-info strong { color: #0056b3; }
        .user-info a { margin-left: 15px; color: #dc3545; text-decoration: none; }
        .user-info a:hover { text-decoration: underline; }

        #worknameSelect {
            display: block !important; 
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc; 
            transition: border-color 0.3s ease;
        }
        #worknameSelect:focus {
            border-color: #0056b3;
            outline: none;
        }
        #worknameSelect option { padding: 8px; border-bottom: 1px solid #ddd; }
        #worknameSelect option:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="BookSKY Logo" class="logo">
            <h2>BookSKY_NET (ãƒ­ã‚°ã‚¤ãƒ³ç‰ˆ2025.6.12)</h2>
        </div>

        {% if session.logged_in_personid %}
        <div class="user-info">
            ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <strong>{{ logged_in_personname }} (ID: {{ logged_in_personid }})</strong>
            <a href="{{ url_for('auth_bp.logout') }}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-message">
                    {% for category, message in messages %}
                        <p class="{{ category }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% else %}
                 <div id="flash-message" style="min-height: 2em;"> 
                    <p style="color: gray;">æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('ui_bp.index') }}">
            <div>
                <label for="person_display">ğŸ“Œ PersonID (ãƒ­ã‚°ã‚¤ãƒ³ä¸­):</label>
                <input type="text" id="person_display" 
                       value="{{ logged_in_personid }} - {{ logged_in_personname }}" 
                       readonly class="form-control">
            </div>

            <label for="workcd">ğŸ” å“ç•ªã‚³ãƒ¼ãƒ‰:</label>
            <input type="text" id="workcd" name="workcd" value="{{ workcd or '' }}" placeholder="3æ¡ä»¥ä¸Šå…¥åŠ›" class="form-control">

            <label for="worknameSelect">ğŸ“š å“å:</label>
            <input type="hidden" id="booknameInput" name="bookname_hidden" value="{{ bookname_hidden or '' }}">
            <select id="worknameSelect" name="workname" class="form-control">
                 <option value="" selected disabled>å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</option>
            </select>
            
            <label for="workprocess">ğŸ›  è¡Œç¨‹å:</label>
            <select id="workprocess" name="workprocess" class="form-control" required>
                <option value="">è¡Œç¨‹åã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                {% for item in workprocess_list %}
                    <option value="{{ item }}" {% if item == workprocess_selected %}selected{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>

            <label for="unitprice_display">ğŸ’° å˜ä¾¡:</label>
            <input type="text" id="unitprice_display" name="unitprice_display_field" value="{{ unitprice or '' }}" readonly class="form-control">

            <label for="workoutput">ğŸ“¦ æ•°é‡ï¼ˆå€‹ã€åˆ†ï¼‰:</label>
            <input type="text" id="workoutput" name="workoutput" value="{{ workoutput or '' }}" class="form-control" required>

            <label for="workday">ğŸ“… ä½œæ¥­æ—¥:</label>
            <input type="date" id="workday" name="workday" value="{{ workday or '' }}" class="form-control" required>
            
            <button type="submit" id="submitButton" class="btn btn-primary">é€ä¿¡</button>
        </form>
    </div>

    <button id="viewRecordsButton" style="margin-top:15px; font-size:18px;">å…¥åŠ›ä¸€è¦§ç¢ºèª</button>

    <script>
        // Pythonã‹ã‚‰æ¸¡ã•ã‚ŒãŸå˜ä¾¡è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ç›´æ¥å—ã‘å–ã‚‹
        const unitpriceDict = {{ unitprice_data_for_js|tojson|safe if unitprice_data_for_js else {} }};

        function debounce(fn, wait) {
            let timer = null;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const workcdInput     = document.getElementById('workcd');
            const booknameInput   = document.getElementById('booknameInput');
            const worknameSelect  = document.getElementById('worknameSelect');
            const workprocessSel  = document.getElementById('workprocess');
            const unitpriceInput  = document.getElementById('unitprice_display');
            const workdayInput    = document.getElementById('workday');
            const viewBtn         = document.getElementById('viewRecordsButton');

            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«workprocessã®åˆæœŸå€¤ãŒã‚ã‚Œã°å˜ä¾¡ã‚’è¨­å®š
            if (workprocessSel && workprocessSel.value && unitpriceDict && unitpriceDict[workprocessSel.value] !== undefined) {
                 if(unitpriceInput) unitpriceInput.value = unitpriceDict[workprocessSel.value];
            }
            
            let suggestionsCache = [];
            let isWorknameSelectShowingMessage = true; 

            if (workcdInput && worknameSelect) {
                if (!workcdInput.value || workcdInput.value.length < 3 ) { 
                    worknameSelect.style.display = 'none'; 
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
                } else { 
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰å†å…¥åŠ›ã¾ãŸã¯å“åã‚’é¸æŠ...');
                    worknameSelect.style.display = 'block';
                }
            } else if (worknameSelect) { 
                 worknameSelect.style.display = 'none'; 
                 populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
            }

            function populateWorknameSelectWithMessage(message, isError = false) {
                if (!worknameSelect) return;
                worknameSelect.innerHTML = ''; 
                const option = document.createElement('option');
                option.textContent = message;
                option.value = ""; 
                option.disabled = true; 
                option.selected = true; 
                worknameSelect.appendChild(option);
                worknameSelect.style.display = 'block'; 
                isWorknameSelectShowingMessage = true; 
                if(booknameInput) booknameInput.value = ''; 
            }

            function expandWorknameOptions() {
                if (!worknameSelect) return;
                if (isWorknameSelectShowingMessage && suggestionsCache.length > 0) {
                    worknameSelect.innerHTML = ''; 
                    const placeholderOption = document.createElement('option');
                    placeholderOption.textContent = 'å“åã‚’é¸æŠã—ã¦ãã ã•ã„...';
                    placeholderOption.value = ""; 
                    placeholderOption.selected = true; 
                    worknameSelect.appendChild(placeholderOption);

                    suggestionsCache.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.workname; 
                        opt.textContent = `${item.code}: ${item.workname} (${item.bookname || 'æ›¸åãªã—'})`; 
                        opt.dataset.code = item.code; 
                        opt.dataset.bookname = item.bookname; 
                        worknameSelect.appendChild(opt);
                    });
                    isWorknameSelectShowingMessage = false; 
                }
            }
            
            if(worknameSelect) {
                worknameSelect.addEventListener('mousedown', expandWorknameOptions);
                worknameSelect.addEventListener('focus', expandWorknameOptions);
                worknameSelect.addEventListener('click', expandWorknameOptions);

                worknameSelect.addEventListener('change', () => {
                const selectedOption = worknameSelect.options[worknameSelect.selectedIndex];
                if (selectedOption && selectedOption.value) {
                    // â˜…â˜…â˜… ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ã§ã™ â˜…â˜…â˜…
                    // å“ç•ªã‚³ãƒ¼ãƒ‰(workcd)ã®å…¥åŠ›æ¬„ã‚’ã€é¸æŠã•ã‚ŒãŸå“åã®å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ã§æ›´æ–°ã—ã¾ã™ã€‚
                    if (workcdInput && selectedOption.dataset.code) {
                        workcdInput.value = selectedOption.dataset.code;
                    }
                    // â˜…â˜…â˜… ä¿®æ­£ã¯ã“ã“ã¾ã§ã§ã™ â˜…â˜…â˜…
                    
                    if(booknameInput) booknameInput.value = selectedOption.dataset.bookname || ""; 
                } else {
                    if(booknameInput) booknameInput.value = ""; 
                }
            });
            }

            const fetchAndFill = debounce(() => {
                if (!workcdInput || !worknameSelect) return;
                const code = workcdInput.value.trim();
                suggestionsCache = []; 

                if (code.length < 3) {
                    worknameSelect.style.display = 'none'; 
                    if(booknameInput) booknameInput.value = '';   
                    isWorknameSelectShowingMessage = true;
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...'); 
                    worknameSelect.value = "";
                    return;
                }

                populateWorknameSelectWithMessage('æ¤œç´¢ä¸­...'); 
                worknameSelect.style.display = 'block'; 

                fetch(`/api/get_worknames?workcd=${encodeURIComponent(code)}`) 
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                    .then(res => {
                        const { ok, status, data } = res;
                        suggestionsCache = []; 

                        if (data.error && data.error !== "") {
                            populateWorknameSelectWithMessage(data.error, true);
                        } else if (!ok) {
                             populateWorknameSelectWithMessage(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (ã‚³ãƒ¼ãƒ‰: ${status})`, true);
                        } else {
                            suggestionsCache = data.worknames || [];
                            if (suggestionsCache.length === 1) {
                                const item = suggestionsCache[0];
                                worknameSelect.innerHTML = ''; 
                                const opt = document.createElement('option');
                                opt.value = item.workname; 
                                opt.textContent = `${item.code}: ${item.workname} (${item.bookname || 'æ›¸åãªã—'})`; 
                                opt.dataset.code = item.code; 
                                opt.dataset.bookname = item.bookname; 
                                opt.selected = true; 
                                worknameSelect.appendChild(opt);
                                worknameSelect.value = item.workname;
                                worknameSelect.dispatchEvent(new Event('change')); 
                                isWorknameSelectShowingMessage = false; 
                            } else if (suggestionsCache.length > 1) {
                                populateWorknameSelectWithMessage(`${suggestionsCache.length}ä»¶ã®å€™è£œã€‚ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ`);
                                worknameSelect.value = "";
                            } else {
                                populateWorknameSelectWithMessage('è©²å½“ã™ã‚‹å“åãŒã‚ã‚Šã¾ã›ã‚“');
                                worknameSelect.value = "";
                            }
                        }
                        worknameSelect.style.display = 'block';
                    })
                    .catch(error => { 
                        console.error('Fetch Error for get_worknames:', error);
                        populateWorknameSelectWithMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
                        if(worknameSelect) worknameSelect.style.display = 'block';
                        if(booknameInput) booknameInput.value = '';
                        if(worknameSelect) worknameSelect.value = "";
                    });
            }, 300); 

            if (workcdInput) {
                workcdInput.addEventListener('input', fetchAndFill);
            }

            if (viewBtn && workdayInput) {
                viewBtn.addEventListener('click', () => {
                    const dateStr = workdayInput.value;
                    let recordsUrl = "{{ url_for('ui_bp.records') }}"; // åŸºæœ¬ã®URL
                    if (dateStr) {
                        const [year, month] = dateStr.split('-');
                        // URLã‚’å®‰å…¨ã«æ§‹ç¯‰ã™ã‚‹ãŸã‚ã«ã€Pythonå´ã§URLã‚’ç”Ÿæˆã™ã‚‹ã®ãŒç†æƒ³ã ãŒã€
                        // JSã§ã‚„ã‚‹å ´åˆã¯ã€ãƒ‘ã‚¹ã‚’ç›´æ¥çµ„ã¿ç«‹ã¦ã‚‹ã‹ã€ãƒ€ãƒŸãƒ¼å¼•æ•°ã§ç”Ÿæˆã—ãŸURLã‚’ç½®æ›ã™ã‚‹
                        recordsUrl = `{{ url_for('ui_bp.records', year=1234, month=56) }}`.replace('1234', year).replace('56', month);
                    }
                    window.location.href = recordsUrl;
                });
            }
            
            if (workdayInput) {
                const lastDay = localStorage.getItem('lastWorkDay');
                if (lastDay) {
                    workdayInput.value = lastDay;
                } else if (!workdayInput.value) { 
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    workdayInput.value = `${yyyy}-${mm}-${dd}`;
                }
                workdayInput.addEventListener('change', () => {
                    localStorage.setItem('lastWorkDay', workdayInput.value);
                });
            }

            if (workprocessSel) {
                workprocessSel.addEventListener('change', () => {
                    if (!unitpriceInput) return;
                    const selectedProcess = workprocessSel.value;
                    if (!selectedProcess) {
                        unitpriceInput.value = ''; 
                        return;
                    }
                    if (unitpriceDict && unitpriceDict[selectedProcess] !== undefined) {
                        unitpriceInput.value = unitpriceDict[selectedProcess];
                    } else {
                        unitpriceInput.value = 'å–å¾—ä¸­...';
                         fetch(`/api/get_unitprice?workprocess=${encodeURIComponent(selectedProcess)}`)
                            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                            .then(res => { 
                                const { ok, status, data } = res;
                                if (data.error && data.error !== "") { unitpriceInput.value = data.error; } 
                                else if (!ok) { unitpriceInput.value = `å–å¾—ã‚¨ãƒ©ãƒ¼ (${status})`;} 
                                else { unitpriceInput.value = data.unitprice !== undefined ? data.unitprice : '';}
                            })
                            .catch(error => { unitpriceInput.value = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼'; });
                    }
                });
                if (workprocessSel.value) {
                    workprocessSel.dispatchEvent(new Event('change'));
                }
            }

            const formElement = document.querySelector('form');
            const submitButton = document.getElementById('submitButton'); 
            if (formElement && submitButton) {
                formElement.addEventListener('submit', (event) => { 
                    const workcdVal = workcdInput ? workcdInput.value.trim() : "";
                    const worknameVal = worknameSelect ? worknameSelect.value : "";
                    
                    if (workcdVal.length >=3 && worknameVal === "" ) {
                         if (isWorknameSelectShowingMessage || (suggestionsCache.length > 0 && worknameSelect.selectedIndex <=0 )) {
                             alert('å“ç•ªã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹å“åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                             event.preventDefault(); 
                             return;
                         }
                    }
                    submitButton.textContent = 'é€ä¿¡ä¸­...';
                    submitButton.disabled = true;
                });
            }
        });
    </script>
</body>
</html>