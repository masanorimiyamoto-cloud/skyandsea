<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable BookSKY_NET å…ˆé€²ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (WTForms)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* ... (æ—¢å­˜ã®CSSã‚¹ã‚¿ã‚¤ãƒ«ã¯ãã®ã¾ã¾) ... */
        .form-field-errors { /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            list-style-type: none;
            padding-left: 0;
            color: red;
            font-size: 0.9em;
            margin-top: 2px;
        }
        .form-field-errors li {
            margin-bottom: 2px;
        }
        /* å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ©ãƒ™ãƒ«ã«ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã‚’è¿½åŠ  */
        label.required::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="BookSKY Logo" class="logo">
            <h2>BookSKY_NET (WTFormsç‰ˆ)</h2>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-message">
                    {% for category, message in messages %}
                        <p class="{{ category }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <form method="POST" novalidate> {{ form.csrf_token }} <div>
                {{ form.personid.label(class="required") }}
                {{ form.personid(class="form-control") }} {# classã¯ãŠä½¿ã„ã®CSSã«åˆã‚ã›ã¦ãã ã•ã„ #}
                {% if form.personid.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.personid.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workcd.label }}
                {{ form.workcd(class="form-control", placeholder="3æ¡ä»¥ä¸Šå…¥åŠ›") }}
                {% if form.workcd.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workcd.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workname.label }}
                {{ form.bookname_hidden() }} {# HiddenFieldã¯é€šå¸¸ãƒ©ãƒ™ãƒ«ãªã—ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° #}
                <select id="worknameSelect" name="workname" class="form-control"></select> {# nameå±æ€§ã‚’form.workname.nameã«åˆã‚ã›ã‚‹ #}
                {% if form.workname.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workname.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
            
            <div>
                {{ form.workprocess.label(class="required") }}
                {{ form.workprocess(class="form-control") }}
                {% if form.workprocess.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workprocess.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                <label for="unitprice">ğŸ’° å˜ä¾¡:</label> {# UnitPriceã¯WTFormsã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ãªã„ãŒã€è¡¨ç¤ºã¯æ®‹ã™ #}
                <input type="text" id="unitprice" name="unitprice_display" readonly class="form-control" value="">
            </div>

            <div>
                {{ form.workoutput.label(class="required") }}
                {{ form.workoutput(class="form-control") }}
                {% if form.workoutput.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workoutput.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workday.label(class="required") }}
                {{ form.workday(class="form-control") }}
                {% if form.workday.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workday.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
            
            {{ form.submit(class="btn btn-primary", id="submitButton") }}
        </form>
    </div>

    <button id="viewRecordsButton" style="margin-top:15px; font-size:18px;">å…¥åŠ›ä¸€è¦§ç¢ºèª</button>

    <script>
        // Pythonã‹ã‚‰æ¸¡ã•ã‚ŒãŸå˜ä¾¡è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
        const unitpriceDict = JSON.parse('{{ unitprice_dict_json|safe if unitprice_dict_json else "{}" }}');

        // debounceé–¢æ•°ã¯å¤‰æ›´ãªã—
        function debounce(fn, wait) { /* ... */ }

        document.addEventListener('DOMContentLoaded', () => {
            const workcdInput     = document.getElementById('workcd'); // WTFormsãŒIDã‚’ç”Ÿæˆã™ã‚‹å ´åˆ form.workcd.id ã§å–å¾—ã‚‚å¯
            const booknameInput   = document.getElementById('{{ form.bookname_hidden.id }}'); // WTFormsã®IDã‚’ä½¿ã†
            const worknameSelect  = document.getElementById('worknameSelect'); // HTMLã§IDå›ºå®š
            const workprocessSel  = document.getElementById('{{ form.workprocess.id }}');
            const unitpriceInput  = document.getElementById('unitprice'); // ã“ã‚Œã¯WTFormã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ãªã„
            const workdayInput    = document.getElementById('{{ form.workday.id }}');
            const viewBtn         = document.getElementById('viewRecordsButton');
            
            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«workprocessã®åˆæœŸå€¤ãŒã‚ã‚Œã°å˜ä¾¡ã‚’è¨­å®š
            if (workprocessSel.value && unitpriceDict[workprocessSel.value] !== undefined) {
                 unitpriceInput.value = unitpriceDict[workprocessSel.value];
            }


            let suggestionsCache = [];
            let isWorknameSelectShowingMessage = true; 

            // åˆæœŸçŠ¶æ…‹ã¯å“ç•ªã‚³ãƒ¼ãƒ‰å…¥åŠ›å¾…ã¡
            if (!workcdInput.value) { // workcdã«åˆæœŸå€¤ãŒãªã‘ã‚Œã°
                worknameSelect.style.display = 'none'; 
                populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
            } else {
                // workcdã«åˆæœŸå€¤ãŒã‚ã‚‹å ´åˆ (ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã§æˆ»ã£ã¦ããŸãªã©) ã¯
                // å¿…è¦ãªã‚‰å†åº¦APIã‚’å©ã„ã¦å€™è£œã‚’è¡¨ç¤ºã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã€‚
                // ãŸã ã—ã€ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã€æ‰‹å‹•å†å…¥åŠ›ã‚’ä¿ƒã™ã€‚
                // ã‚‚ã—ãã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ workname ã®é¸æŠè‚¢ã‚‚å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ (ã‚ˆã‚Šè¤‡é›‘)
                // fetchAndFill(); // ã“ã‚Œã‚’å‘¼ã¶ã¨åˆæœŸå€¤ã§æ¤œç´¢ãŒèµ°ã‚‹
                if (workcdInput.value.length >= 3) {
                     populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰å†å…¥åŠ›ã¾ãŸã¯å“åã‚’é¸æŠ...');
                     worknameSelect.style.display = 'block';
                     // ã‚‚ã—ã‚¨ãƒ©ãƒ¼ã§æˆ»ã£ã¦ããŸéš›ã« workname ã®å€¤ã‚‚å¾©å…ƒã—ãŸã„å ´åˆã€
                     // Pythonå´ã§ form.workname.data ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æ¸¡ã—ã€ã“ã“ã§è¨­å®šã™ã‚‹
                     // const initialWorkname = "{{ form.workname.data or '' }}";
                     // if(initialWorkname) { ... }
                } else {
                     worknameSelect.style.display = 'none';
                     populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
                }
            }


            function populateWorknameSelectWithMessage(message, isError = false) { /* ... (å¤‰æ›´ãªã—) ... */ }
            function expandWorknameOptions() { /* ... (å¤‰æ›´ãªã—) ... */ }

            worknameSelect.addEventListener('mousedown', expandWorknameOptions);
            worknameSelect.addEventListener('focus', expandWorknameOptions);
            worknameSelect.addEventListener('click', expandWorknameOptions);

            worknameSelect.addEventListener('change', () => {
                const selectedOption = worknameSelect.options[worknameSelect.selectedIndex];
                if (selectedOption && selectedOption.value) { // valueãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
                    // workcdInput.value = selectedOption.dataset.code || workcdInput.value; // WTFormså´ã§å‡¦ç†ã™ã‚‹ã®ã§ä¸è¦ã‹ã‚‚
                    booknameInput.value = selectedOption.dataset.bookname || ""; 
                    // workname (StringField)ã«ã¯é¸æŠã•ã‚ŒãŸ workname ãŒè‡ªå‹•ã§å…¥ã‚‹ã¯ãš
                } else {
                    booknameInput.value = ""; 
                }
            });

            const fetchAndFill = debounce(() => { /* ... (fetch URLã¯ /api/get_worknames ã®ã¾ã¾) ... */ 
                const code = workcdInput.value.trim();
                suggestionsCache = []; 

                if (code.length < 3) {
                    worknameSelect.style.display = 'none'; 
                    booknameInput.value = '';   
                    isWorknameSelectShowingMessage = true;
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...'); 
                    // ãƒ•ã‚©ãƒ¼ãƒ ã® workname ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ã‚¯ãƒªã‚¢
                    document.getElementsByName("workname")[0].value = ""; // WTFormsãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç›´æ¥æ“ä½œã™ã‚‹å ´åˆã¯æ³¨æ„
                    return;
                }

                populateWorknameSelectWithMessage('æ¤œç´¢ä¸­...'); 
                worknameSelect.style.display = 'block'; 

                fetch(`/api/get_worknames?workcd=${encodeURIComponent(code)}`) 
                    .then(response => {
                        return response.json().then(data => ({ ok: response.ok, status: response.status, data }));
                    })
                    .then(res => {
                        const { ok, status, data } = res;
                        suggestionsCache = []; 

                        if (data.error && data.error !== "") {
                            console.error(`API Error for get_worknames (status ${status}):`, data.error);
                            populateWorknameSelectWithMessage(data.error, true);
                        } else if (!ok) {
                             console.error(`HTTP Error for get_worknames: ${status}`);
                             populateWorknameSelectWithMessage(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (ã‚³ãƒ¼ãƒ‰: ${status})`, true);
                        } else {
                            suggestionsCache = data.worknames || [];
                            if (suggestionsCache.length === 1) {
                                const item = suggestionsCache[0];
                                worknameSelect.innerHTML = ''; 
                                const opt = document.createElement('option');
                                opt.value = item.workname; // WTFormsã®StringField 'workname' ã«ã“ã®å€¤ãŒå…¥ã‚‹
                                opt.textContent = `${item.code}: ${item.workname}`; 
                                opt.dataset.code = item.code; 
                                opt.dataset.bookname = item.bookname; 
                                opt.selected = true; 
                                worknameSelect.appendChild(opt);
                                // worknameSelect ã® change ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦ã€hidden field ãªã©ã‚’æ›´æ–°
                                worknameSelect.dispatchEvent(new Event('change')); 
                                // booknameInput.value = item.bookname || "";  // changeã‚¤ãƒ™ãƒ³ãƒˆå†…ã§å‡¦ç†
                                // workcdInput.value = item.code; // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’ä¸Šæ›¸ãã—ãªã„æ–¹ãŒè‰¯ã„å ´åˆã‚‚ã‚ã‚‹
                                isWorknameSelectShowingMessage = false; 
                            } else if (suggestionsCache.length > 1) {
                                populateWorknameSelectWithMessage(`${suggestionsCache.length}ä»¶ã®å€™è£œã€‚ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ`);
                                document.getElementsByName("workname")[0].value = ""; // é¸æŠå¾…ã¡ãªã®ã§ã‚¯ãƒªã‚¢
                            } else {
                                populateWorknameSelectWithMessage('è©²å½“ã™ã‚‹å“åãŒã‚ã‚Šã¾ã›ã‚“');
                                document.getElementsByName("workname")[0].value = ""; // ã‚¯ãƒªã‚¢
                            }
                        }
                        worknameSelect.style.display = 'block';
                    })
                    .catch(error => { 
                        console.error('Fetch Error for get_worknames:', error);
                        populateWorknameSelectWithMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
                        worknameSelect.style.display = 'block';
                        booknameInput.value = '';
                        document.getElementsByName("workname")[0].value = "";
                    });
            }, 300); 

            workcdInput.addEventListener('input', fetchAndFill);

            viewBtn.addEventListener('click', () => { /* ... (å¤‰æ›´ãªã—) ... */ });
            
            // localStorage for workday ã¯å¤‰æ›´ãªã—
            // ...

            workprocessSel.addEventListener('change', () => {
                const selectedProcess = workprocessSel.value;
                if (!selectedProcess) {
                    unitpriceInput.value = ''; 
                    return;
                }
                // Pythonã‹ã‚‰æ¸¡ã•ã‚ŒãŸunitpriceDictã‚’ä½¿ç”¨
                if (unitpriceDict && unitpriceDict[selectedProcess] !== undefined) {
                    unitpriceInput.value = unitpriceDict[selectedProcess];
                } else {
                    // ã‚‚ã—è¾æ›¸ã«ãªã„å ´åˆã‚„ã€APIã‚’å©ããŸã„å ´åˆã¯å¾“æ¥ã®fetchã‚’æ®‹ã™
                    console.warn(`UnitPrice for ${selectedProcess} not found in initial dict. Consider fetching if dynamic.`);
                    unitpriceInput.value = 'å–å¾—ä¸­...'; // or fetch
                     fetch(`/api/get_unitprice?workprocess=${encodeURIComponent(selectedProcess)}`)
                        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                        .then(res => { /* ... (å¾“æ¥ã®fetchãƒ­ã‚¸ãƒƒã‚¯ã€ã‚¨ãƒ©ãƒ¼å‡¦ç†æ”¹å–„ç‰ˆ) ... */ 
                            const { ok, status, data } = res;
                            if (data.error && data.error !== "") {
                                unitpriceInput.value = data.error; 
                            } else if (!ok) {
                                unitpriceInput.value = `å–å¾—ã‚¨ãƒ©ãƒ¼ (${status})`;
                            } else {
                                unitpriceInput.value = data.unitprice !== undefined ? data.unitprice : '';
                            }
                        })
                        .catch(error => {
                            unitpriceInput.value = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
                        });
                }
            });

            const form = document.querySelector('form');
            const submitBtn = document.getElementById('{{ form.submit.id }}'); // WTFormsã®IDã‚’ä½¿ã†
            form.addEventListener('submit', (event) => { // eventå¼•æ•°ã‚’è¿½åŠ 
                const workcdVal = workcdInput.value.trim();
                // worknameSelect.value ã¯ populateWorknameSelectWithMessage ã§ "" ã«ãªã‚‹ã®ã§ã€
                // isWorknameSelectShowingMessage ã‚„ suggestionsCache.length ã‚’ä½¿ã£ãŸåˆ¤å®šãŒé©åˆ‡
                if (workcdVal.length >=3 && isWorknameSelectShowingMessage && suggestionsCache.length > 0) {
                     // å€™è£œãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¦ã€ã‹ã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸çŠ¶æ…‹ï¼ˆï¼æœªé¸æŠï¼‰ã®å ´åˆ
                    alert('å“ç•ªã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹å“åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    event.preventDefault(); 
                    return;
                }
                 if (workcdVal.length >=3 && worknameSelect.value === "" && suggestionsCache.length > 0 && !isWorknameSelectShowingMessage) {
                    // å€™è£œãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã§ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã€Œå“åã‚’é¸æŠã—ã¦ãã ã•ã„...ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
                     alert('å“åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                     event.preventDefault();
                     return;
                 }

                submitBtn.textContent = 'é€ä¿¡ä¸­...';
                submitBtn.disabled = true;
            });
        });
    </script>
</body>
</html>