<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable BookSKY_NET (WTForms)</title> <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* ... (æ—¢å­˜ã®CSSã¯ãã®ã¾ã¾) ... */
        .form-field-errors { /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            list-style-type: none;
            padding-left: 0;
            color: red;
            font-size: 0.9em;
            margin-top: 2px;
            margin-bottom: 5px;
        }
        .form-field-errors li {
            margin-bottom: 2px;
        }
        label.required::after { /* å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ©ãƒ™ãƒ«ã«ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ */
            content: " *";
            color: red;
        }
        .form-control { /* WTFormsãŒç”Ÿæˆã™ã‚‹inputãªã©ã«é©ç”¨ã™ã‚‹å…±é€šã‚¯ãƒ©ã‚¹ */
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 20px;
            box-sizing: border-box;
        }
        select.form-control { /* selectã«ã‚‚é©ç”¨ */
             height: auto; /* selectã®é«˜ã•èª¿æ•´ */
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="BookSKY Logo" class="logo">
            <h2>BookSKY_NET (WTFormsç‰ˆ)</h2>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-message">
                    {% for category, message in messages %}
                        <p class="{{ category }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <form method="POST" novalidate> {{ form.csrf_token }} <div>
                {{ form.personid.label(class="required") }} {{ form.personid(class="form-control") }}
                {% if form.personid.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.personid.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workcd.label }}
                {{ form.workcd(class="form-control", placeholder="3æ¡ä»¥ä¸Šå…¥åŠ›") }}
                {% if form.workcd.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workcd.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workname.label }}
                {{ form.bookname_hidden() }} {# HiddenFieldã¯é€šå¸¸ãƒ©ãƒ™ãƒ«ãªã—ã€IDã¯è‡ªå‹•ç”Ÿæˆ #}
                {# worknameSelect ã¯æ‰‹å‹•ã§é…ç½®ã—ã€nameå±æ€§ã‚’WTFormsã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«åˆã‚ã›ã‚‹ #}
                <select id="worknameSelect" name="workname" class="form-control"></select> 
                {% if form.workname.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workname.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
            
            <div>
                {{ form.workprocess.label(class="required") }}
                {{ form.workprocess(class="form-control") }}
                {% if form.workprocess.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workprocess.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                <label for="unitprice_display">ğŸ’° å˜ä¾¡:</label> {# è¡¨ç¤ºå°‚ç”¨ã®å˜ä¾¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ #}
                <input type="text" id="unitprice_display" name="unitprice_display" readonly class="form-control">
            </div>

            <div>
                {{ form.workoutput.label(class="required") }}
                {{ form.workoutput(class="form-control") }}
                {% if form.workoutput.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workoutput.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workday.label(class="required") }}
                {{ form.workday(class="form-control") }}
                {% if form.workday.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workday.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
            
            {{ form.submit(class="btn btn-primary", id="submitButton") }}
        </form>
    </div>

    <button id="viewRecordsButton" style="margin-top:15px; font-size:18px;">å…¥åŠ›ä¸€è¦§ç¢ºèª</button>

    <script>
        // Pythonã‹ã‚‰æ¸¡ã•ã‚ŒãŸå˜ä¾¡è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã«æ³¨æ„: |safe ã‚’ä½¿ã†ã®ã¯ã€å†…å®¹ã‚’ä¿¡é ¼ã§ãã‚‹å ´åˆã®ã¿ã€‚
        // é€šå¸¸ã¯ã€JSONæ–‡å­—åˆ—ã‚’HTMLã®dataå±æ€§ã«å…¥ã‚Œã‚‹ã‹ã€
        // scriptã‚¿ã‚°å†…ã§JSå¤‰æ•°ã«ä»£å…¥ã™ã‚‹éš›ã«Flaskã®tojsonãƒ•ã‚£ãƒ«ã‚¿ã‚’ä½¿ã†ã®ãŒã‚ˆã‚Šå®‰å…¨ã€‚
        // ã“ã“ã§ã¯ã€unitprice_dict_json ãŒé©åˆ‡ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸJSONæ–‡å­—åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’æœŸå¾…ã€‚
        const unitpriceDict = JSON.parse('{{ unitprice_dict_json|tojson|safe if unitprice_dict_json else "{}" }}');

        function debounce(fn, wait) {
            let timer = null;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            // WTFormsãŒç”Ÿæˆã™ã‚‹IDã‚’å„ªå…ˆçš„ã«ä½¿ç”¨ (form.field.id ã§å–å¾—)
            const workcdInput     = document.getElementById('{{ form.workcd.id }}');
            const booknameInput   = document.getElementById('{{ form.bookname_hidden.id }}');
            const worknameSelect  = document.getElementById('worknameSelect'); // HTMLã§IDå›ºå®šãªã®ã§ã“ã®ã¾ã¾
            const workprocessSel  = document.getElementById('{{ form.workprocess.id }}');
            const unitpriceInput  = document.getElementById('unitprice_display'); // è¡¨ç¤ºå°‚ç”¨ã®IDã«å¤‰æ›´
            const workdayInput    = document.getElementById('{{ form.workday.id }}');
            const viewBtn         = document.getElementById('viewRecordsButton');
            const personidSelect  = document.getElementById('{{ form.personid.id }}');


            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«workprocessã®åˆæœŸå€¤ãŒã‚ã‚Œã°å˜ä¾¡ã‚’è¨­å®š
            // (formã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰åˆæœŸå€¤ã‚’å–å¾—ã—ã€ãã‚Œã«åŸºã¥ã„ã¦è¡¨ç¤ºã™ã‚‹)
            const initialWorkprocess = workprocessSel.value;
            if (initialWorkprocess && unitpriceDict[initialWorkprocess] !== undefined) {
                 unitpriceInput.value = unitpriceDict[initialWorkprocess];
            }


            let suggestionsCache = [];
            let isWorknameSelectShowingMessage = true; 

            if (!workcdInput.value && workcdInput.placeholder !== "3æ¡ä»¥ä¸Šå…¥åŠ›") { 
                // åˆæœŸå€¤ãŒãªãã€ã‹ã¤ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ï¼ˆã¤ã¾ã‚Šä¸€åº¦å…¥åŠ›ãŒã‚ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ï¼‰å ´åˆã‚’è€ƒæ…®
                // ã¾ãŸã¯ã€å˜ã«åˆæœŸè¡¨ç¤º
                worknameSelect.style.display = 'none'; 
                populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
            } else if (workcdInput.value.length >= 3) {
                // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«workcdã«æ—¢ã«å€¤ãŒã‚ã‚‹å ´åˆ (ã‚¨ãƒ©ãƒ¼ã§æˆ»ã£ã¦ããŸãªã©)
                // fetchAndFill(); // å³æ™‚å®Ÿè¡Œã™ã‚‹ã¨APIè² è·ã€‚å¿…è¦ãªã‚‰é…å»¶å®Ÿè¡Œã‚„åˆ¥ã®ãƒˆãƒªã‚¬ãƒ¼ã§ã€‚
                // ã¾ãŸã¯ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã‚¨ãƒ©ãƒ¼æ™‚ã« workname ã®é¸æŠè‚¢ã‚‚å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
                // ã“ã“ã§ã¯ã€åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å†æ“ä½œã‚’ä¿ƒã™ã€‚
                populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰å†å…¥åŠ›ã¾ãŸã¯å“åã‚’é¸æŠ...');
                worknameSelect.style.display = 'block';
            } else { // workcdãŒç©ºã¾ãŸã¯3æ–‡å­—æœªæº€
                worknameSelect.style.display = 'none'; 
                populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
            }


            function populateWorknameSelectWithMessage(message, isError = false) {
                worknameSelect.innerHTML = ''; 
                const option = document.createElement('option');
                option.textContent = message;
                option.value = ""; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã¯valueã‚’ç©ºã«ã™ã‚‹
                option.disabled = true; 
                option.selected = true; 
                worknameSelect.appendChild(option);
                worknameSelect.style.display = 'block'; 
                isWorknameSelectShowingMessage = true; 
                if(booknameInput) booknameInput.value = ''; 
            }

            function expandWorknameOptions() {
                if (isWorknameSelectShowingMessage && suggestionsCache.length > 0) {
                    worknameSelect.innerHTML = ''; 
                    const placeholderOption = document.createElement('option');
                    placeholderOption.textContent = 'å“åã‚’é¸æŠã—ã¦ãã ã•ã„...';
                    placeholderOption.value = ""; // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®valueã‚‚ç©º
                    placeholderOption.selected = true; 
                    worknameSelect.appendChild(placeholderOption);

                    suggestionsCache.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.workname; // WTFormsã®StringField 'workname' ã«ã“ã®å€¤ãŒå…¥ã‚‹
                        opt.textContent = `${item.code}: ${item.workname} (${item.bookname || 'æ›¸åãªã—'})`; 
                        opt.dataset.code = item.code; 
                        opt.dataset.bookname = item.bookname; 
                        worknameSelect.appendChild(opt);
                    });
                    isWorknameSelectShowingMessage = false; 
                }
            }

            if(worknameSelect) { // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                worknameSelect.addEventListener('mousedown', expandWorknameOptions);
                worknameSelect.addEventListener('focus', expandWorknameOptions);
                worknameSelect.addEventListener('click', expandWorknameOptions);

                worknameSelect.addEventListener('change', () => {
                    const selectedOption = worknameSelect.options[worknameSelect.selectedIndex];
                    if (selectedOption && selectedOption.value) { 
                        // workcdInput.value = selectedOption.dataset.code || workcdInput.value; // WorkCDã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’å°Šé‡
                        if(booknameInput) booknameInput.value = selectedOption.dataset.bookname || ""; 
                        // form.workname (StringField) ã«ã¯é¸æŠã•ã‚ŒãŸ workname ãŒè‡ªå‹•ã§é€ä¿¡ã•ã‚Œã‚‹
                    } else {
                        if(booknameInput) booknameInput.value = ""; 
                    }
                });
            }


            const fetchAndFill = debounce(() => {
                if (!workcdInput) return; // workcdInputãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
                const code = workcdInput.value.trim();
                suggestionsCache = []; 

                if (code.length < 3) {
                    if(worknameSelect) worknameSelect.style.display = 'none'; 
                    if(booknameInput) booknameInput.value = '';   
                    isWorknameSelectShowingMessage = true;
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...'); 
                    // ãƒ•ã‚©ãƒ¼ãƒ ã® workname ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ã‚¯ãƒªã‚¢ (nameå±æ€§ã§å–å¾—)
                    const formWorknameField = document.getElementsByName("workname")[0];
                    if (formWorknameField) formWorknameField.value = "";
                    return;
                }

                populateWorknameSelectWithMessage('æ¤œç´¢ä¸­...'); 
                if(worknameSelect) worknameSelect.style.display = 'block'; 

                fetch(`/api/get_worknames?workcd=${encodeURIComponent(code)}`) 
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                    .then(res => {
                        const { ok, status, data } = res;
                        suggestionsCache = []; 

                        if (data.error && data.error !== "") {
                            populateWorknameSelectWithMessage(data.error, true);
                        } else if (!ok) {
                             populateWorknameSelectWithMessage(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (ã‚³ãƒ¼ãƒ‰: ${status})`, true);
                        } else {
                            suggestionsCache = data.worknames || [];
                            if (suggestionsCache.length === 1) {
                                const item = suggestionsCache[0];
                                if(worknameSelect) worknameSelect.innerHTML = ''; 
                                const opt = document.createElement('option');
                                opt.value = item.workname; 
                                opt.textContent = `${item.code}: ${item.workname} (${item.bookname || 'æ›¸åãªã—'})`; 
                                opt.dataset.code = item.code; 
                                opt.dataset.bookname = item.bookname; 
                                opt.selected = true; 
                                if(worknameSelect) worknameSelect.appendChild(opt);
                                
                                // é¸æŠã•ã‚ŒãŸå€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
                                const formWorknameField = document.getElementsByName("workname")[0];
                                if(formWorknameField) formWorknameField.value = item.workname;
                                if(booknameInput) booknameInput.value = item.bookname || "";  
                                // workcdInput.value = item.code; // å¿…è¦ãªã‚‰WorkCDã‚‚æ›´æ–°

                                isWorknameSelectShowingMessage = false; 
                            } else if (suggestionsCache.length > 1) {
                                populateWorknameSelectWithMessage(`${suggestionsCache.length}ä»¶ã®å€™è£œã€‚ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ`);
                                const formWorknameField = document.getElementsByName("workname")[0];
                                if (formWorknameField) formWorknameField.value = "";
                            } else {
                                populateWorknameSelectWithMessage('è©²å½“ã™ã‚‹å“åãŒã‚ã‚Šã¾ã›ã‚“');
                                const formWorknameField = document.getElementsByName("workname")[0];
                                if (formWorknameField) formWorknameField.value = "";
                            }
                        }
                        if(worknameSelect) worknameSelect.style.display = 'block';
                    })
                    .catch(error => { 
                        console.error('Fetch Error for get_worknames:', error);
                        populateWorknameSelectWithMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
                        if(worknameSelect) worknameSelect.style.display = 'block';
                        if(booknameInput) booknameInput.value = '';
                        const formWorknameField = document.getElementsByName("workname")[0];
                        if (formWorknameField) formWorknameField.value = "";
                    });
            }, 300); 

            if (workcdInput) { // workcdInput ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                workcdInput.addEventListener('input', fetchAndFill);
            }

            if (viewBtn) { // viewBtn ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                viewBtn.addEventListener('click', () => {
                    if (!personidSelect || !workdayInput) return;
                    const pid  = personidSelect.value;
                    const dateStr = workdayInput.value;
                    if (!pid) {
                        alert('PersonIDã‚’é¸æŠã—ã¦ãã ã•ã„');
                        return;
                    }
                    if (!dateStr && pid) {
                         window.location.href = `/records?personid=${pid}`;
                         return;
                    }
                    if (dateStr) {
                        const [year, month] = dateStr.split('-');
                        window.location.href = `/records/${year}/${month}?personid=${pid}`;
                    } else {
                         alert('PersonIDã¨ä½œæ¥­æ—¥ã‚’é¸æŠã¾ãŸã¯å…¥åŠ›ã—ã¦ãã ã•ã„');
                    }
                });
            }
            
            if (workdayInput) { // workdayInput ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                const lastDay = localStorage.getItem('lastWorkDay');
                if (lastDay) {
                    workdayInput.value = lastDay;
                } else if (!workdayInput.value) { 
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    workdayInput.value = `${yyyy}-${mm}-${dd}`;
                }
                workdayInput.addEventListener('change', () => {
                    localStorage.setItem('lastWorkDay', workdayInput.value);
                });
            }

            if (workprocessSel) { // workprocessSel ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                workprocessSel.addEventListener('change', () => {
                    if (!unitpriceInput) return;
                    const selectedProcess = workprocessSel.value;
                    if (!selectedProcess) {
                        unitpriceInput.value = ''; 
                        return;
                    }
                    if (unitpriceDict && unitpriceDict[selectedProcess] !== undefined) {
                        unitpriceInput.value = unitpriceDict[selectedProcess];
                    } else {
                        unitpriceInput.value = 'å–å¾—ä¸­...';
                         fetch(`/api/get_unitprice?workprocess=${encodeURIComponent(selectedProcess)}`)
                            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                            .then(res => { 
                                const { ok, status, data } = res;
                                if (data.error && data.error !== "") { unitpriceInput.value = data.error; } 
                                else if (!ok) { unitpriceInput.value = `å–å¾—ã‚¨ãƒ©ãƒ¼ (${status})`;} 
                                else { unitpriceInput.value = data.unitprice !== undefined ? data.unitprice : '';}
                            })
                            .catch(error => { unitpriceInput.value = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼'; });
                    }
                });
            }

            const formElement = document.querySelector('form'); // formã‚¿ã‚°ã¯ä¸€ã¤ã¨ä»®å®š
            const submitButton = document.getElementById('{{ form.submit.id }}');
            if (formElement && submitButton) { // è¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                formElement.addEventListener('submit', (event) => { 
                    const workcdVal = workcdInput ? workcdInput.value.trim() : "";
                    const worknameVal = worknameSelect ? worknameSelect.value : "";

                    if (workcdVal.length >=3 && worknameVal === "" && suggestionsCache.length > 0) {
                        if (isWorknameSelectShowingMessage || (suggestionsCache.length > 0 && worknameSelect.selectedIndex <=0 )) { // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºä¸­ or ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼é¸æŠä¸­
                             alert('å“ç•ªã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹å“åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                             event.preventDefault(); 
                             return;
                        }
                    }
                    submitButton.textContent = 'é€ä¿¡ä¸­...';
                    submitButton.disabled = true;
                });
            }
        });
    </script>
</body>
</html>