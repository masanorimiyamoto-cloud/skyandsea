<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airtable BookSKY_NET (WTForms)</title> <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        /* ... (既存のCSSはそのまま) ... */
        .form-field-errors { /* エラーメッセージ表示用のスタイル */
            list-style-type: none;
            padding-left: 0;
            color: red;
            font-size: 0.9em;
            margin-top: 2px;
            margin-bottom: 5px;
        }
        .form-field-errors li {
            margin-bottom: 2px;
        }
        label.required::after { /* 必須フィールドのラベルにアスタリスク */
            content: " *";
            color: red;
        }
        .form-control { /* WTFormsが生成するinputなどに適用する共通クラス */
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 20px;
            box-sizing: border-box;
        }
        select.form-control { /* selectにも適用 */
             height: auto; /* selectの高さ調整 */
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="BookSKY Logo" class="logo">
            <h2>BookSKY_NET (WTForms版)</h2>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-message">
                    {% for category, message in messages %}
                        <p class="{{ category }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <form method="POST" novalidate> {{ form.csrf_token }} <div>
                {{ form.personid.label(class="required") }} {{ form.personid(class="form-control") }}
                {% if form.personid.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.personid.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workcd.label }}
                {{ form.workcd(class="form-control", placeholder="3桁以上入力") }}
                {% if form.workcd.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workcd.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workname.label }}
                {{ form.bookname_hidden() }} {# HiddenFieldは通常ラベルなし、IDは自動生成 #}
                {# worknameSelect は手動で配置し、name属性をWTFormsのフィールド名に合わせる #}
                <select id="worknameSelect" name="workname" class="form-control"></select> 
                {% if form.workname.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workname.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
            
            <div>
                {{ form.workprocess.label(class="required") }}
                {{ form.workprocess(class="form-control") }}
                {% if form.workprocess.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workprocess.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                <label for="unitprice_display">💰 単価:</label> {# 表示専用の単価フィールド #}
                <input type="text" id="unitprice_display" name="unitprice_display" readonly class="form-control">
            </div>

            <div>
                {{ form.workoutput.label(class="required") }}
                {{ form.workoutput(class="form-control") }}
                {% if form.workoutput.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workoutput.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div>
                {{ form.workday.label(class="required") }}
                {{ form.workday(class="form-control") }}
                {% if form.workday.errors %}
                    <ul class="form-field-errors">
                        {% for error in form.workday.errors %}<li>{{ error }}</li>{% endfor %}
                    </ul>
                {% endif %}
            </div>
            
            {{ form.submit(class="btn btn-primary", id="submitButton") }}
        </form>
    </div>

    <button id="viewRecordsButton" style="margin-top:15px; font-size:18px;">入力一覧確認</button>

    <script>
        // Pythonから渡された単価辞書データをJavaScriptオブジェクトとしてパース
        // エスケープ処理に注意: |safe を使うのは、内容を信頼できる場合のみ。
        // 通常は、JSON文字列をHTMLのdata属性に入れるか、
        // scriptタグ内でJS変数に代入する際にFlaskのtojsonフィルタを使うのがより安全。
        // ここでは、unitprice_dict_json が適切にエスケープされたJSON文字列であることを期待。
        const unitpriceDict = JSON.parse('{{ unitprice_dict_json|tojson|safe if unitprice_dict_json else "{}" }}');

        function debounce(fn, wait) {
            let timer = null;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            // WTFormsが生成するIDを優先的に使用 (form.field.id で取得)
            const workcdInput     = document.getElementById('{{ form.workcd.id }}');
            const booknameInput   = document.getElementById('{{ form.bookname_hidden.id }}');
            const worknameSelect  = document.getElementById('worknameSelect'); // HTMLでID固定なのでこのまま
            const workprocessSel  = document.getElementById('{{ form.workprocess.id }}');
            const unitpriceInput  = document.getElementById('unitprice_display'); // 表示専用のIDに変更
            const workdayInput    = document.getElementById('{{ form.workday.id }}');
            const viewBtn         = document.getElementById('viewRecordsButton');
            const personidSelect  = document.getElementById('{{ form.personid.id }}');


            // ページロード時にworkprocessの初期値があれば単価を設定
            // (formオブジェクトから初期値を取得し、それに基づいて表示する)
            const initialWorkprocess = workprocessSel.value;
            if (initialWorkprocess && unitpriceDict[initialWorkprocess] !== undefined) {
                 unitpriceInput.value = unitpriceDict[initialWorkprocess];
            }


            let suggestionsCache = [];
            let isWorknameSelectShowingMessage = true; 

            if (!workcdInput.value && workcdInput.placeholder !== "3桁以上入力") { 
                // 初期値がなく、かつプレースホルダーが表示されていない（つまり一度入力があったかもしれない）場合を考慮
                // または、単に初期表示
                worknameSelect.style.display = 'none'; 
                populateWorknameSelectWithMessage('品番コードを3桁以上入力...');
            } else if (workcdInput.value.length >= 3) {
                // ページロード時にworkcdに既に値がある場合 (エラーで戻ってきたなど)
                // fetchAndFill(); // 即時実行するとAPI負荷。必要なら遅延実行や別のトリガーで。
                // または、サーバーサイドでエラー時に workname の選択肢も復元できるようにする。
                // ここでは、初期メッセージを表示し、ユーザーの再操作を促す。
                populateWorknameSelectWithMessage('品番コード再入力または品名を選択...');
                worknameSelect.style.display = 'block';
            } else { // workcdが空または3文字未満
                worknameSelect.style.display = 'none'; 
                populateWorknameSelectWithMessage('品番コードを3桁以上入力...');
            }


            function populateWorknameSelectWithMessage(message, isError = false) {
                worknameSelect.innerHTML = ''; 
                const option = document.createElement('option');
                option.textContent = message;
                option.value = ""; // メッセージ表示時はvalueを空にする
                option.disabled = true; 
                option.selected = true; 
                worknameSelect.appendChild(option);
                worknameSelect.style.display = 'block'; 
                isWorknameSelectShowingMessage = true; 
                if(booknameInput) booknameInput.value = ''; 
            }

            function expandWorknameOptions() {
                if (isWorknameSelectShowingMessage && suggestionsCache.length > 0) {
                    worknameSelect.innerHTML = ''; 
                    const placeholderOption = document.createElement('option');
                    placeholderOption.textContent = '品名を選択してください...';
                    placeholderOption.value = ""; // プレースホルダーのvalueも空
                    placeholderOption.selected = true; 
                    worknameSelect.appendChild(placeholderOption);

                    suggestionsCache.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.workname; // WTFormsのStringField 'workname' にこの値が入る
                        opt.textContent = `${item.code}: ${item.workname} (${item.bookname || '書名なし'})`; 
                        opt.dataset.code = item.code; 
                        opt.dataset.bookname = item.bookname; 
                        worknameSelect.appendChild(opt);
                    });
                    isWorknameSelectShowingMessage = false; 
                }
            }

            if(worknameSelect) { // 要素が存在する場合のみリスナーを設定
                worknameSelect.addEventListener('mousedown', expandWorknameOptions);
                worknameSelect.addEventListener('focus', expandWorknameOptions);
                worknameSelect.addEventListener('click', expandWorknameOptions);

                worknameSelect.addEventListener('change', () => {
                    const selectedOption = worknameSelect.options[worknameSelect.selectedIndex];
                    if (selectedOption && selectedOption.value) { 
                        // workcdInput.value = selectedOption.dataset.code || workcdInput.value; // WorkCDはユーザー入力値を尊重
                        if(booknameInput) booknameInput.value = selectedOption.dataset.bookname || ""; 
                        // form.workname (StringField) には選択された workname が自動で送信される
                    } else {
                        if(booknameInput) booknameInput.value = ""; 
                    }
                });
            }


            const fetchAndFill = debounce(() => {
                if (!workcdInput) return; // workcdInputがなければ何もしない
                const code = workcdInput.value.trim();
                suggestionsCache = []; 

                if (code.length < 3) {
                    if(worknameSelect) worknameSelect.style.display = 'none'; 
                    if(booknameInput) booknameInput.value = '';   
                    isWorknameSelectShowingMessage = true;
                    populateWorknameSelectWithMessage('品番コードを3桁以上入力...'); 
                    // フォームの workname フィールドもクリア (name属性で取得)
                    const formWorknameField = document.getElementsByName("workname")[0];
                    if (formWorknameField) formWorknameField.value = "";
                    return;
                }

                populateWorknameSelectWithMessage('検索中...'); 
                if(worknameSelect) worknameSelect.style.display = 'block'; 

                fetch(`/api/get_worknames?workcd=${encodeURIComponent(code)}`) 
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                    .then(res => {
                        const { ok, status, data } = res;
                        suggestionsCache = []; 

                        if (data.error && data.error !== "") {
                            populateWorknameSelectWithMessage(data.error, true);
                        } else if (!ok) {
                             populateWorknameSelectWithMessage(`サーバーエラー (コード: ${status})`, true);
                        } else {
                            suggestionsCache = data.worknames || [];
                            if (suggestionsCache.length === 1) {
                                const item = suggestionsCache[0];
                                if(worknameSelect) worknameSelect.innerHTML = ''; 
                                const opt = document.createElement('option');
                                opt.value = item.workname; 
                                opt.textContent = `${item.code}: ${item.workname} (${item.bookname || '書名なし'})`; 
                                opt.dataset.code = item.code; 
                                opt.dataset.bookname = item.bookname; 
                                opt.selected = true; 
                                if(worknameSelect) worknameSelect.appendChild(opt);
                                
                                // 選択された値をフォームフィールドに反映
                                const formWorknameField = document.getElementsByName("workname")[0];
                                if(formWorknameField) formWorknameField.value = item.workname;
                                if(booknameInput) booknameInput.value = item.bookname || "";  
                                // workcdInput.value = item.code; // 必要ならWorkCDも更新

                                isWorknameSelectShowingMessage = false; 
                            } else if (suggestionsCache.length > 1) {
                                populateWorknameSelectWithMessage(`${suggestionsCache.length}件の候補。クリック/タップして選択`);
                                const formWorknameField = document.getElementsByName("workname")[0];
                                if (formWorknameField) formWorknameField.value = "";
                            } else {
                                populateWorknameSelectWithMessage('該当する品名がありません');
                                const formWorknameField = document.getElementsByName("workname")[0];
                                if (formWorknameField) formWorknameField.value = "";
                            }
                        }
                        if(worknameSelect) worknameSelect.style.display = 'block';
                    })
                    .catch(error => { 
                        console.error('Fetch Error for get_worknames:', error);
                        populateWorknameSelectWithMessage('通信エラーが発生しました', true);
                        if(worknameSelect) worknameSelect.style.display = 'block';
                        if(booknameInput) booknameInput.value = '';
                        const formWorknameField = document.getElementsByName("workname")[0];
                        if (formWorknameField) formWorknameField.value = "";
                    });
            }, 300); 

            if (workcdInput) { // workcdInput が存在する場合のみリスナーを設定
                workcdInput.addEventListener('input', fetchAndFill);
            }

            if (viewBtn) { // viewBtn が存在する場合のみリスナーを設定
                viewBtn.addEventListener('click', () => {
                    if (!personidSelect || !workdayInput) return;
                    const pid  = personidSelect.value;
                    const dateStr = workdayInput.value;
                    if (!pid) {
                        alert('PersonIDを選択してください');
                        return;
                    }
                    if (!dateStr && pid) {
                         window.location.href = `/records?personid=${pid}`;
                         return;
                    }
                    if (dateStr) {
                        const [year, month] = dateStr.split('-');
                        window.location.href = `/records/${year}/${month}?personid=${pid}`;
                    } else {
                         alert('PersonIDと作業日を選択または入力してください');
                    }
                });
            }
            
            if (workdayInput) { // workdayInput が存在する場合のみリスナーを設定
                const lastDay = localStorage.getItem('lastWorkDay');
                if (lastDay) {
                    workdayInput.value = lastDay;
                } else if (!workdayInput.value) { 
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    workdayInput.value = `${yyyy}-${mm}-${dd}`;
                }
                workdayInput.addEventListener('change', () => {
                    localStorage.setItem('lastWorkDay', workdayInput.value);
                });
            }

            if (workprocessSel) { // workprocessSel が存在する場合のみリスナーを設定
                workprocessSel.addEventListener('change', () => {
                    if (!unitpriceInput) return;
                    const selectedProcess = workprocessSel.value;
                    if (!selectedProcess) {
                        unitpriceInput.value = ''; 
                        return;
                    }
                    if (unitpriceDict && unitpriceDict[selectedProcess] !== undefined) {
                        unitpriceInput.value = unitpriceDict[selectedProcess];
                    } else {
                        unitpriceInput.value = '取得中...';
                         fetch(`/api/get_unitprice?workprocess=${encodeURIComponent(selectedProcess)}`)
                            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                            .then(res => { 
                                const { ok, status, data } = res;
                                if (data.error && data.error !== "") { unitpriceInput.value = data.error; } 
                                else if (!ok) { unitpriceInput.value = `取得エラー (${status})`;} 
                                else { unitpriceInput.value = data.unitprice !== undefined ? data.unitprice : '';}
                            })
                            .catch(error => { unitpriceInput.value = '通信エラー'; });
                    }
                });
            }

            const formElement = document.querySelector('form'); // formタグは一つと仮定
            const submitButton = document.getElementById('{{ form.submit.id }}');
            if (formElement && submitButton) { // 要素が存在する場合のみリスナーを設定
                formElement.addEventListener('submit', (event) => { 
                    const workcdVal = workcdInput ? workcdInput.value.trim() : "";
                    const worknameVal = worknameSelect ? worknameSelect.value : "";

                    if (workcdVal.length >=3 && worknameVal === "" && suggestionsCache.length > 0) {
                        if (isWorknameSelectShowingMessage || (suggestionsCache.length > 0 && worknameSelect.selectedIndex <=0 )) { // メッセージ表示中 or プレースホルダー選択中
                             alert('品番コードに対応する品名を選択してください。');
                             event.preventDefault(); 
                             return;
                        }
                    }
                    submitButton.textContent = '送信中...';
                    submitButton.disabled = true;
                });
            }
        });
    </script>
</body>
</html>