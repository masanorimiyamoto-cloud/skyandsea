<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿å…¥åŠ› - BookSKY_NET (ãƒ­ã‚°ã‚¤ãƒ³ç‰ˆ)</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            padding: 20px;
            margin: 0; /* bodyã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
        }
        .container {
            max-width: 400px;
            margin: auto;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            text-align: left;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 20px; 
            box-sizing: border-box;
        }
        input[readonly] { /* èª­ã¿å–ã‚Šå°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        button {
            background-color: #007bff;
            color: white;
            font-size: 18px;
            border: none;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #submitButton {
            margin-top: 30px;
        }
        .message {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .header { text-align: center; margin-bottom: 20px; }
        .logo { max-width: 100px; height: auto; margin-bottom: 10px; }
        .user-info { 
            margin-bottom: 15px; 
            padding: 10px; 
            background-color: #f0f0f0; /* å°‘ã—è–„ã„èƒŒæ™¯è‰² */
            border: 1px solid #ddd; /* æ ç·š */
            border-radius: 5px; 
            text-align: center; 
            font-size: 0.9em; /* å°‘ã—å°ã•ã‚ã®ãƒ•ã‚©ãƒ³ãƒˆ */
        }
        .user-info strong { color: #0056b3; } /* å¼·èª¿è¡¨ç¤ºã®è‰² */
        .user-info a { margin-left: 15px; color: #dc3545; text-decoration: none; } /* ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒªãƒ³ã‚¯ã®è‰² */
        .user-info a:hover { text-decoration: underline; }

        #worknameSelect { /* JavaScriptã§æ“ä½œã™ã‚‹å“åé¸æŠ */
            display: block !important; /* åˆæœŸéè¡¨ç¤ºã§ã‚‚JSã§blockã«ã™ã‚‹ã®ã§!important */
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ccc; /* é€šå¸¸ã®å…¥åŠ›æ¬„ã¨åˆã‚ã›ã‚‹ */
            /* border: 2px solid #007bff; */ /* å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ« */
            transition: border-color 0.3s ease;
        }
        #worknameSelect:focus {
            border-color: #0056b3;
            outline: none;
        }
        #worknameSelect option { padding: 8px; border-bottom: 1px solid #ddd; }
        #worknameSelect option:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='images/logo.jpg') }}" alt="BookSKY Logo" class="logo">
            <h2>BookSKY_NET (ãƒ­ã‚°ã‚¤ãƒ³ç‰ˆ2025.6.4)</h2>
        </div>

        {% if session.logged_in_personid %}
        <div class="user-info">
            ãƒ­ã‚°ã‚¤ãƒ³ä¸­: <strong>{{ session.logged_in_personname }} (ID: {{ session.logged_in_personid }})</strong>
            <a href="{{ url_for('auth_bp.logout') }}">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-message">
                    {% for category, message in messages %}
                        <p class="{{ category }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% else %}
                 <div id="flash-message" style="min-height: 2em;"> {# ç©ºã§ã‚‚é«˜ã•ã‚’ç¢ºä¿ #}
                    <p style="color: gray;">æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('ui_bp.index') }}"> {# ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ˜ç¤º #}
            {# CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯Flask-WTFå°å…¥æ™‚ã«å†åº¦è¿½åŠ ã—ã¾ã™ #}

            <div>
                <label for="person_display">ğŸ“Œ PersonID (ãƒ­ã‚°ã‚¤ãƒ³ä¸­):</label>
                <input type="text" id="person_display" 
                       value="{{ logged_in_personid }} - {{ logged_in_personname }}" 
                       readonly class="form-control">
                {# ã‚µãƒ¼ãƒãƒ¼ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®IDã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®personidé€ä¿¡ã¯ä¸è¦ #}
            </div>

            <label for="workcd">ğŸ” å“ç•ªã‚³ãƒ¼ãƒ‰:</label>
            <input type="text" id="workcd" name="workcd" value="{{ workcd or '' }}" placeholder="3æ¡ä»¥ä¸Šå…¥åŠ›" class="form-control">

            <label for="worknameSelect">ğŸ“š å“å:</label>
            <input type="hidden" id="booknameInput" name="bookname_hidden" value="{{ bookname_hidden or '' }}">
            <select id="worknameSelect" name="workname" class="form-control">
                 <option value="" selected disabled>å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</option>
            </select>
            
            <label for="workprocess">ğŸ›  è¡Œç¨‹å:</label>
            <select id="workprocess" name="workprocess" class="form-control" required>
                <option value="">è¡Œç¨‹åã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                {% for item in workprocess_list %}
                    <option value="{{ item }}" {% if item == workprocess_selected %}selected{% endif %}>{{ item }}</option>
                {% endfor %}
            </select>

            <label for="unitprice_display">ğŸ’° å˜ä¾¡:</label>
            <input type="text" id="unitprice_display" name="unitprice_display_field" value="{{ unitprice or '' }}" readonly class="form-control">

            <label for="workoutput">ğŸ“¦ æ•°é‡ï¼ˆå€‹ã€åˆ†ï¼‰:</label>
            <input type="text" id="workoutput" name="workoutput" value="{{ workoutput or '' }}" class="form-control" required>

            <label for="workday">ğŸ“… ä½œæ¥­æ—¥:</label>
            <input type="date" id="workday" name="workday" value="{{ workday or '' }}" class="form-control" required>
            
            <button type="submit" id="submitButton" class="btn btn-primary">é€ä¿¡</button>
        </form>
    </div>

    <button id="viewRecordsButton" style="margin-top:15px; font-size:18px;">å…¥åŠ›ä¸€è¦§ç¢ºèª</button>

    <script>
        const unitpriceDict = JSON.parse('{{ unitprice_dict_json|tojson|safe if unitprice_dict_json else "{}" }}');

        function debounce(fn, wait) {
            let timer = null;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', () => {
            const workcdInput     = document.getElementById('workcd');
            const booknameInput   = document.getElementById('booknameInput');
            const worknameSelect  = document.getElementById('worknameSelect');
            const workprocessSel  = document.getElementById('workprocess');
            const unitpriceInput  = document.getElementById('unitprice_display');
            const workdayInput    = document.getElementById('workday');
            const viewBtn         = document.getElementById('viewRecordsButton');
            // const personidSelect  = document.getElementById('personid'); // ã“ã‚Œã¯ã‚‚ã†å­˜åœ¨ã—ãªã„

            // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«workprocessã®åˆæœŸå€¤ãŒã‚ã‚Œã°å˜ä¾¡ã‚’è¨­å®š
            if (workprocessSel && workprocessSel.value && unitpriceDict[workprocessSel.value] !== undefined) {
                 if(unitpriceInput) unitpriceInput.value = unitpriceDict[workprocessSel.value];
            }
            
            let suggestionsCache = [];
            let isWorknameSelectShowingMessage = true; 

            if (workcdInput && worknameSelect) {
                if (!workcdInput.value || workcdInput.value.length < 3 ) { 
                    worknameSelect.style.display = 'none'; 
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
                } else { // åˆæœŸå€¤ãŒ3æ–‡å­—ä»¥ä¸Šã‚ã‚‹å ´åˆï¼ˆã‚¨ãƒ©ãƒ¼ã§æˆ»ã£ã¦ããŸãªã©ï¼‰
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰å†å…¥åŠ›ã¾ãŸã¯å“åã‚’é¸æŠ...');
                    worknameSelect.style.display = 'block';
                    // å¿…è¦ã§ã‚ã‚Œã°ã€ã“ã“ã§ fetchAndFill() ã‚’ä¸€åº¦å‘¼ã³å‡ºã—ã¦å€™è£œã‚’å†å–å¾—ã™ã‚‹ã“ã¨ã‚‚æ¤œè¨
                    // fetchAndFill(); // ãŸã ã—ãƒ‡ãƒã‚¦ãƒ³ã‚¹ãªã—ã§å³æ™‚å®Ÿè¡Œã—ãŸã„å ´åˆãªã©å·¥å¤«ãŒå¿…è¦
                }
            } else if (worknameSelect) { // workcdInput ãŒãªãã¦ã‚‚ worknameSelect ã¯åˆæœŸåŒ–
                 worknameSelect.style.display = 'none'; 
                 populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...');
            }


            function populateWorknameSelectWithMessage(message, isError = false) {
                if (!worknameSelect) return;
                worknameSelect.innerHTML = ''; 
                const option = document.createElement('option');
                option.textContent = message;
                option.value = ""; 
                option.disabled = true; 
                option.selected = true; 
                worknameSelect.appendChild(option);
                worknameSelect.style.display = 'block'; 
                isWorknameSelectShowingMessage = true; 
                if(booknameInput) booknameInput.value = ''; 
            }

            function expandWorknameOptions() {
                if (!worknameSelect) return;
                if (isWorknameSelectShowingMessage && suggestionsCache.length > 0) {
                    worknameSelect.innerHTML = ''; 
                    const placeholderOption = document.createElement('option');
                    placeholderOption.textContent = 'å“åã‚’é¸æŠã—ã¦ãã ã•ã„...';
                    placeholderOption.value = ""; 
                    placeholderOption.selected = true; 
                    worknameSelect.appendChild(placeholderOption);

                    suggestionsCache.forEach(item => {
                        const opt = document.createElement('option');
                        opt.value = item.workname; 
                        opt.textContent = `${item.code}: ${item.workname} (${item.bookname || 'æ›¸åãªã—'})`; 
                        opt.dataset.code = item.code; 
                        opt.dataset.bookname = item.bookname; 
                        worknameSelect.appendChild(opt);
                    });
                    isWorknameSelectShowingMessage = false; 
                }
            }
            
            if(worknameSelect) {
                worknameSelect.addEventListener('mousedown', expandWorknameOptions);
                worknameSelect.addEventListener('focus', expandWorknameOptions);
                worknameSelect.addEventListener('click', expandWorknameOptions);

                worknameSelect.addEventListener('change', () => {
                    const selectedOption = worknameSelect.options[worknameSelect.selectedIndex];
                    if (selectedOption && selectedOption.value) { 
                        if(booknameInput) booknameInput.value = selectedOption.dataset.bookname || ""; 
                        // workcdInput.value = selectedOption.dataset.code || workcdInput.value; // å“ç•ªã‚³ãƒ¼ãƒ‰ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ã‚’å°Šé‡
                    } else {
                        if(booknameInput) booknameInput.value = ""; 
                    }
                });
            }

            const fetchAndFill = debounce(() => {
                if (!workcdInput || !worknameSelect) return;
                const code = workcdInput.value.trim();
                suggestionsCache = []; 

                if (code.length < 3) {
                    worknameSelect.style.display = 'none'; 
                    if(booknameInput) booknameInput.value = '';   
                    isWorknameSelectShowingMessage = true;
                    populateWorknameSelectWithMessage('å“ç•ªã‚³ãƒ¼ãƒ‰ã‚’3æ¡ä»¥ä¸Šå…¥åŠ›...'); 
                    // name="workname" ã® select ã®å€¤ã‚’ã‚¯ãƒªã‚¢
                    worknameSelect.value = ""; // ã“ã‚Œã§é¸æŠè‚¢ãŒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ãªã‚‰å®Ÿè³ªã‚¯ãƒªã‚¢
                    return;
                }

                populateWorknameSelectWithMessage('æ¤œç´¢ä¸­...'); 
                worknameSelect.style.display = 'block'; 

                fetch(`/api/get_worknames?workcd=${encodeURIComponent(code)}`) 
                    .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                    .then(res => {
                        const { ok, status, data } = res;
                        suggestionsCache = []; 

                        if (data.error && data.error !== "") {
                            populateWorknameSelectWithMessage(data.error, true);
                        } else if (!ok) {
                             populateWorknameSelectWithMessage(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (ã‚³ãƒ¼ãƒ‰: ${status})`, true);
                        } else {
                            suggestionsCache = data.worknames || [];
                            if (suggestionsCache.length === 1) {
                                const item = suggestionsCache[0];
                                worknameSelect.innerHTML = ''; 
                                const opt = document.createElement('option');
                                opt.value = item.workname; 
                                opt.textContent = `${item.code}: ${item.workname} (${item.bookname || 'æ›¸åãªã—'})`; 
                                opt.dataset.code = item.code; 
                                opt.dataset.bookname = item.bookname; 
                                opt.selected = true; 
                                worknameSelect.appendChild(opt);
                                worknameSelect.value = item.workname; // æ˜ç¤ºçš„ã«å€¤ã‚’è¨­å®š
                                worknameSelect.dispatchEvent(new Event('change')); // changeã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
                                isWorknameSelectShowingMessage = false; 
                            } else if (suggestionsCache.length > 1) {
                                populateWorknameSelectWithMessage(`${suggestionsCache.length}ä»¶ã®å€™è£œã€‚ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ`);
                                worknameSelect.value = "";
                            } else {
                                populateWorknameSelectWithMessage('è©²å½“ã™ã‚‹å“åãŒã‚ã‚Šã¾ã›ã‚“');
                                worknameSelect.value = "";
                            }
                        }
                        worknameSelect.style.display = 'block';
                    })
                    .catch(error => { 
                        console.error('Fetch Error for get_worknames:', error);
                        populateWorknameSelectWithMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', true);
                        if(worknameSelect) worknameSelect.style.display = 'block';
                        if(booknameInput) booknameInput.value = '';
                        if(worknameSelect) worknameSelect.value = "";
                    });
            }, 300); 

            if (workcdInput) {
                workcdInput.addEventListener('input', fetchAndFill);
            }

            if (viewBtn && workdayInput) {
                viewBtn.addEventListener('click', () => {
                    const dateStr = workdayInput.value;
                    // PersonIDã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ä½¿ã‚ã‚Œã‚‹ã®ã§ã€URLã«å«ã‚ã‚‹å¿…è¦ã¯åŸºæœ¬çš„ã«ãªã„
                    // ui_bp.records ãŒ personid URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»»æ„ã§å—ã‘ä»˜ã‘ã‚‹ãªã‚‰æ¸¡ã—ã¦ã‚‚ã‚ˆã„ãŒã€
                    // ã“ã“ã§ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ©ç”¨ã‚’å‰æã¨ã—ã€URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã¯å¤–ã™
                    if (!dateStr) {
                        window.location.href = "{{ url_for('ui_bp.records') }}"; 
                        return;
                    }
                    const [year, month] = dateStr.split('-');
                    // url_forã®å¼•æ•°ã«0ã‚’æ¸¡ã—ã¦ä¸€æ™‚çš„ãªURLã‚’ç”Ÿæˆã—ã€å®Ÿéš›ã®å¹´æœˆã§ç½®æ› (ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã¯Pythonå´ã§ã®URLç”Ÿæˆ)
                    let recordsUrl = "{{ url_for('ui_bp.records', year=1234, month=56) }}"; // ãƒ€ãƒŸãƒ¼ã®å¹´æœˆ
                    recordsUrl = recordsUrl.replace('1234', year).replace('56', month);
                    window.location.href = recordsUrl;
                });
            }
            
            if (workdayInput) {
                const lastDay = localStorage.getItem('lastWorkDay');
                if (lastDay) {
                    workdayInput.value = lastDay;
                } else if (!workdayInput.value) { // Pythonå´ã‹ã‚‰å€¤ãŒæ¸¡ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿JSã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
                    const today = new Date();
                    const yyyy = today.getFullYear();
                    const mm = String(today.getMonth() + 1).padStart(2, '0');
                    const dd = String(today.getDate()).padStart(2, '0');
                    workdayInput.value = `${yyyy}-${mm}-${dd}`;
                }
                workdayInput.addEventListener('change', () => {
                    localStorage.setItem('lastWorkDay', workdayInput.value);
                });
            }

            if (workprocessSel) {
                workprocessSel.addEventListener('change', () => {
                    if (!unitpriceInput) return;
                    const selectedProcess = workprocessSel.value;
                    if (!selectedProcess) {
                        unitpriceInput.value = ''; 
                        return;
                    }
                    if (unitpriceDict && unitpriceDict[selectedProcess] !== undefined) {
                        unitpriceInput.value = unitpriceDict[selectedProcess];
                    } else {
                        unitpriceInput.value = 'å–å¾—ä¸­...';
                         fetch(`/api/get_unitprice?workprocess=${encodeURIComponent(selectedProcess)}`)
                            .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                            .then(res => { 
                                const { ok, status, data } = res;
                                if (data.error && data.error !== "") { unitpriceInput.value = data.error; } 
                                else if (!ok) { unitpriceInput.value = `å–å¾—ã‚¨ãƒ©ãƒ¼ (${status})`;} 
                                else { unitpriceInput.value = data.unitprice !== undefined ? data.unitprice : '';}
                            })
                            .catch(error => { unitpriceInput.value = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼'; });
                    }
                });
                // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã« workprocessSel ã«å€¤ãŒã‚ã‚Œã° change ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦å˜ä¾¡ã‚’è¡¨ç¤º
                if (workprocessSel.value) {
                    workprocessSel.dispatchEvent(new Event('change'));
                }
            }

            const formElement = document.querySelector('form');
            const submitButton = document.getElementById('submitButton'); // é€ä¿¡ãƒœã‚¿ãƒ³ã®IDãŒ submitButton ã§ã‚ã‚‹ã¨ä»®å®š
            if (formElement && submitButton) {
                formElement.addEventListener('submit', (event) => { 
                    const workcdVal = workcdInput ? workcdInput.value.trim() : "";
                    const worknameVal = worknameSelect ? worknameSelect.value : "";
                    
                    if (workcdVal.length >=3 && worknameVal === "" ) {
                         if (isWorknameSelectShowingMessage || (suggestionsCache.length > 0 && worknameSelect.selectedIndex <=0 )) {
                             alert('å“ç•ªã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹å“åã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                             event.preventDefault(); 
                             return;
                         }
                    }
                    submitButton.textContent = 'é€ä¿¡ä¸­...';
                    submitButton.disabled = true;
                });
            }
        });
    </script>
</body>
</html>